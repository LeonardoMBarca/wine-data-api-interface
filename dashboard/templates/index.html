<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Com√©rcio de Vinhos</title>
    <link rel="stylesheet" href="{{ url_for('dashboard.static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .update-button {
            background-color: #4285f4;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .update-button:hover {
            background-color: #3367d6;
        }
        .update-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .loading {
            display: none;
            margin-left: 10px;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 20px; color: #1a73e8;">üìä Painel de Com√©rcio de Vinhos</h2>

<div style="background-color: #f0f4f8; padding: 20px; display: flex; justify-content: center; gap: 15px; border-bottom: 2px solid #1a73e8;">
    <a href="{{ url_for('dashboard.index') }}" style="text-decoration: none;">
        <button style="background-color: #1a73e8; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            üì¶ Com√©rcio
        </button>
    </a>
    <a href="{{ url_for('dashboard.exportacao') }}" style="text-decoration: none;">
        <button style="background-color: #34a853; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            üåç Exporta√ß√£o
        </button>
    </a>
    <a href="{{ url_for('dashboard.importacao') }}" style="text-decoration: none;">
        <button style="background-color: #fbbc05; color: black; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            üõ¨ Importa√ß√£o
        </button>
    </a>
    <a href="{{ url_for('dashboard.processamento') }}" style="text-decoration: none;">
        <button style="background-color: #ff7043; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            ‚öôÔ∏è Processamento
        </button>
    </a>
    <a href="{{ url_for('dashboard.producao') }}" style="text-decoration: none;">
        <button style="background-color: #9c27b0; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            üß™ Produ√ß√£o
        </button>
    </a>
</div>

    <div style="text-align: center; margin: 20px 0;">
        <button id="atualizar-dados" class="update-button">
            üîÑ Atualizar Dados
            <div id="loading" class="loading"></div>
        </button>
        <div id="status-message" class="status-message"></div>
    </div>

    <div class="filters">
        <label>Ano:
            <select id="filtro-ano">
                <option value="">Todos</option>
                {% for valor in filtros['ano'] %}
                    <option value="{{ valor }}">{{ valor }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Categoria:
            <select id="filtro-categoria">
                <option value="">Todas</option>
                {% for valor in filtros['categoria'] %}
                    <option value="{{ valor }}">{{ valor }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Subcategoria:
            <select id="filtro-subcategoria">
                <option value="">Todas</option>
                {% for valor in filtros['subcategoria'] %}
                    <option value="{{ valor }}">{{ valor }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Tipo/Estilo:
            <select id="filtro-tipo">
                <option value="">Todos</option>
                {% for valor in filtros['tipo_estilo'] %}
                    <option value="{{ valor }}">{{ valor }}</option>
                {% endfor %}
            </select>
        </label>
        <label>Processamento:
            <select id="filtro-processamento">
                <option value="">Todos</option>
                {% for valor in filtros['processamento'] %}
                    <option value="{{ valor }}">{{ valor }}</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <div class="resumo">
        <p>Total de Litros: <span id="total-litros">0</span> L</p>
        <p>Registros encontrados: <span id="total-registros">0</span></p>
    </div>

    <div class="graficos">
        <canvas id="grafico-barras" height="200" style="max-height: 280px;"></canvas>
        <canvas id="grafico-pizza" height="200" style="max-height: 280px;"></canvas>
    </div>

    <table>
        <thead>
            <tr>
                {% for coluna in colunas %}
                    <th>{{ coluna }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        window.dadosComercio = {{ dados | tojson }};
        window.colunasComercio = {{ colunas | tojson }};
        
        // Script para atualiza√ß√£o de dados
        document.getElementById('atualizar-dados').addEventListener('click', function() {
            const button = this;
            const loading = document.getElementById('loading');
            const statusMessage = document.getElementById('status-message');
            
            // Desabilita o bot√£o e mostra o indicador de carregamento
            button.disabled = true;
            loading.style.display = 'block';
            statusMessage.style.display = 'none';
            statusMessage.className = 'status-message';
            
            // Faz a requisi√ß√£o para atualizar os dados
            fetch('/atualizar-dados', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                statusMessage.style.display = 'block';
                
                if (data.status === 'success') {
                    statusMessage.textContent = data.message;
                    statusMessage.classList.add('success');
                    // Recarrega a p√°gina ap√≥s 2 segundos para mostrar os dados atualizados
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    statusMessage.textContent = data.message;
                    statusMessage.classList.add('error');
                    button.disabled = false;
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                statusMessage.style.display = 'block';
                statusMessage.textContent = 'Erro ao conectar com o servidor.';
                statusMessage.classList.add('error');
                button.disabled = false;
            });
        });
    </script>
    <script src="{{ url_for('dashboard.static', filename='js/script_comercio.js') }}"></script>
</body>
</html>